\section{System dynamics}

Our approach is to divert patients proactively to prevent
congestion from happening. If we identify
a beneficial diversion, we will call the patient $l$ time
before his appointment time and offer the patient
the opportunity to be diverted, when the parameter $l$
is a lead time that can be adjusted. The patient can accept or
decline this diversion. In fact, we propose a system where
a patient must first "opt in", or volunteers to be called
for a potential diversion. The patient's "volunteer" status
is determined before the scan day and only volunteers
will be diverted. To make sure patients
are incentivized to cooperate, we aim to pick diversions
that will make the patient to be diverted wait less.

We use a discrete-event system (see \cite{kelton2000simulation}
for reference) to describe our system. We are going
to describe the entities and their associated states. Then, we
will describe all of the events and how they change system states.
Finally, we will describe the inputs of this model and how
we use data to fit these inputs.

\subsection{Entities and states}

There are multiple sites in the system:
\begin{itemize}
\item Each site has one or more machines.
\item Each machine can process at most one patient at any time.
  Once a scan is started, it cannot be preempted (that is, that
  patient's scan must be completed before the next patient's
  scan to start)
\item There is a single waiting room at each site to accommodate
      patients who have arrived but have not yet started their scans.
\item Each site has a opening time and a closing time for each day.
      The site is supposed to only operate only inside this time window.
\end{itemize}
We make a simplifying assumption here: all machines are homogeneous
and are capable to conduct any type of scan. In reality, this is not
true, but we believe the effects of the few cases in which this becomes
relevant do not justify the complicating in our overall model.

The central entity is an appointment. Each appointment is associated
with one patient and has the following states:
\begin{itemize}
\item Appointment time
\item Slot size
\item Appointment status. This could be
  \begin{itemize}
  \item "scheduled but has not shown up"
  \item "arrived and preparing for scan"
  \item "ready for scan"
  \item "under scan"
  \item "scan completed"
  \item "cancelled"
  \end{itemize}
\item Assigned site. This may change due to diversion.
\item Type of scan.
\item Machine occupied. Only valid when patient is "under scan".
\item Various timestamps
  \begin{itemize}
  \item Arrival time
  \item Ready time
  \item Scan begin time
  \item Scan completion time
  \end{itemize}
\end{itemize}
Same-Day Add-On Patient (SDAOP) will appear at
a site without an appointment. Similarly in our system, there is no
appointment for them until their arrival.

Last but not least, we also track the current time in the system.


\subsection{Events}

The following a complete enumeration of all events that we consider:
\begin{itemize}
\item Patient arrival. This happens when a patient arrives at
      the assigned site. Note this can be a SDAOP.
\item Patient ready. This happens when a patient has finished his preparation
      after arriving at the site. The preparation may include completing
      paperwork, changing clothes and being put on an intravenous therapy (IV).
\item Cancellation. This happens when a patient notifies the hospital
      that he will not fulfill the appointment.
\item Scan begin. When a machine is idling, the patient who is ready
      with earliest appointment time will be started.
\item Scan completion.
\item Diversion. This happens when we successfully divert a patient
      to another site. 
\end{itemize}
In numerical experiments, we shall assume there are no "no-shows".
In practice, a no-show is quite rare since it is not easy to get an appointment,
and we believe this assumption is appropriate. In practice, we can deal
with a no-show by changing the appointment's status to "cancelled"
when the patient does not arrive within a certain threshold of
the appointment time. If the patient does show up later, we will
change the status to "arrived and preparing for scan".

In numerical experiments, we also assume all diversions are successful.
The justification for this is that we will experiment with different fractions of volunteers
and a low fraction of volunteers can be partially interpreted as
unsuccessful diversions.

\subsection{Model inputs}

The model needs the following inputs:
\begin{itemize}
\item the schedule at the beginning of the day, including
      appointments across all sites;
\item the set of patients who are volunteers;
\item the distribution of arrival time per appointment;
\item the distribution of preparation time per appointment;
\item the distribution of scan duration per appointment;
\item the set of SDAOPs and their arrival times;
\item cancellations.
\end{itemize}
Here we describe an ideal scenario where we know the distributional
information for each appointment. In practice, we need to
use historical data to fit these distributions and we cannot
hope to reach the granularity of the per appointment level.
For scan duration, we fit one distribution for each type of scan.
For arrival time and preparation time, we fit one distribution
for the whole population. 

We are making (admittedly substantial) assumptions on these sources of randomness.
For example, when a site is running behind schedule, the staff
may work faster. In fact, scan duration is dependent on the current status
of a site (in terms of the congestion being observed).
There are many factors in reality and we cannot
hope to model all of them. So we focus on constructing a model
that is qualitatively similar enough to reality, and show that our
results are robust under a range of parameters influencing the
behavior of the system.

These model inputs are used to simulate daily operations, and
some of them are not available to our diversion policy.
For example, our policy does not know about SDAOPs and cancellation
until they happen.

We will discuss how to fit these inputs in the section on
numerical experiments.

\subsection{Metric}

There are two things we care about: patient waiting time and
site overtime. For one patient, if the appointment time is $a$
and the scan begins at time $t$, then waiting time is defined
to be
\[  (t - a)^+. \]
For each machine, the overtime $o$ is defined to be the amount of
time this machine is working outside the operating time window
of the site where the machine resides.

We are not only interested in average waiting time and
overtime, we are interested in the distribution of waiting time
and overtime. For example, we pay particular attention to extreme
waiting times (for example, $\ge$60 minutes or $\ge$90 minutes of waiting time)
since they are very important for the service quality perceived by patients.
As a result, we will demonstrate the impact of diversions via
multiple statistics on waiting time and overtime.
